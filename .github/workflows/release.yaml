name: Release
on:
  push:
    tags:
      - "v*.*.*"
permissions:
  contents: write # allow pushing commits back to the repo
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"
      - name: Make build script executable
        run: chmod +x build/jcscli/build.sh
      - name: Run build script
        env:
          # pass the tag name as VERSION (GITHUB_REF_NAME is the tag, e.g. v1.2.3)
          VERSION: ${{ github.ref_name }}
        run: |
          # If triggered by workflow_dispatch, you can fall back to "dev"
          if [ -z "${VERSION:-}" ]; then
            VERSION="dev"
          fi
          echo "Running build/jcscli/build.sh with VERSION=$VERSION"
          ./build/jcscli/build.sh "$VERSION"
      - name: List dist contents (debug)
        run: ls -la dist || true
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: jcscli-dist
          path: dist/**
          if-no-files-found: error
  changelog:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Install git-chglog
        run: |
          go install github.com/git-chglog/git-chglog/cmd/git-chglog@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH
      - name: Generate CHANGELOG.md
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          set -euxo pipefail

          # Ensure VERSION is set (fallback for manual runs)
          if [ -z "${VERSION:-}" ]; then
            VERSION="dev"
          fi

          echo "Generating CHANGELOG for $VERSION"

          # Find previous tag (if any)
          PREV_TAG=""
          if git rev-parse --verify "refs/tags/$VERSION" >/dev/null 2>&1; then
            # If current ref is a tag, try to find the previous tag reachable from it
            PREV_TAG=$(git describe --tags --abbrev=0 "$VERSION^" 2>/dev/null || true)
          fi
          # If PREV_TAG still empty, try to get the latest tag before HEAD
          if [ -z "$PREV_TAG" ]; then
            PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || true)
          fi

          echo "Previous tag: ${PREV_TAG:-<none>}"

          # Build changelog body from commits since PREV_TAG (or from start if none)
          if [ -n "$PREV_TAG" ]; then
            CHANGELOG_BODY=$(git log --pretty=format:'- %s (%h)' "${PREV_TAG}..HEAD")
          else
            CHANGELOG_BODY=$(git log --pretty=format:'- %s (%h)' --max-count=50)
          fi

          # If no commits found, add a placeholder line
          if [ -z "$CHANGELOG_BODY" ]; then
            CHANGELOG_BODY="- No notable changes recorded."
          fi

          # Prepend new section to CHANGELOG.md
          DATE=$(date +"%Y-%m-%d")
          TMPFILE=$(mktemp)
          {
            echo "## ${VERSION} - ${DATE}"
            echo ""
            echo "### Changes"
            echo "$CHANGELOG_BODY"
            echo ""
            echo ""
            # Append existing changelog if present
            if [ -f CHANGELOG.md ]; then
              cat CHANGELOG.md
            fi
          } > "$TMPFILE"
          mv "$TMPFILE" CHANGELOG.md

          # Commit and push if there are changes
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git status --porcelain | grep -q CHANGELOG.md; then
            git add CHANGELOG.md
            git commit -m "Update CHANGELOG for ${VERSION}"
            # Push using the default token provided to the runner
            git push
            echo "CHANGELOG.md updated and pushed."
          else
            echo "No changes to CHANGELOG.md; nothing to commit."
          fi
  release:
    runs-on: ubuntu-latest
    needs: [build, changelog]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: dist
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/**/*
          generate_release_notes: true
