name: Release
on:
  push:
    tags:
      - "v*.*.*"
permissions:
  contents: write # allow pushing commits back to the repo
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"
      - name: Make build script executable
        run: chmod +x ./build/jcscli/build.sh
      - name: Run build script
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          set -euxo pipefail
          cd "${{ github.workspace }}"
          if [ -z "${VERSION:-}" ]; then
            VERSION="dev"
          fi
          echo "Running build/jcscli/build.sh with VERSION=$VERSION"
          ./build/jcscli/build.sh "$VERSION"
      - name: Show dist contents
        run: ls -la dist || true
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: jcscli-dist
          path: dist/**
          if-no-files-found: error
  changelog:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Generate simple CHANGELOG and push branch
        env:
          VERSION: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail

          if [ -z "${VERSION:-}" ]; then
            VERSION="dev"
          fi
          echo "Generating CHANGELOG for ${VERSION}"

          PREV_TAG=""
          if git rev-parse --verify "refs/tags/${VERSION}" >/dev/null 2>&1; then
            PREV_TAG=$(git describe --tags --abbrev=0 "${VERSION}^" 2>/dev/null || true)
          fi
          if [ -z "$PREV_TAG" ]; then
            PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || true)
          fi
          echo "Previous tag: ${PREV_TAG:-<none>}"

          if [ -n "$PREV_TAG" ]; then
            CHANGELOG_BODY=$(git log --pretty=format:'- %s (%h)' "${PREV_TAG}..HEAD")
          else
            CHANGELOG_BODY=$(git log --pretty=format:'- %s (%h)' --max-count=50)
          fi

          if [ -z "$CHANGELOG_BODY" ]; then
            CHANGELOG_BODY="- No notable changes recorded."
          fi

          DATE=$(date +"%Y-%m-%d")
          TMPFILE=$(mktemp)
          {
            echo "## ${VERSION} - ${DATE}"
            echo ""
            echo "### Changes"
            echo "$CHANGELOG_BODY"
            echo ""
            echo ""
            if [ -f CHANGELOG.md ]; then
              cat CHANGELOG.md
            fi
          } > "$TMPFILE"
          mv "$TMPFILE" CHANGELOG.md

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git status --porcelain | grep -q CHANGELOG.md; then
            git add CHANGELOG.md
            git commit -m "Update CHANGELOG for ${VERSION}"

            SAFE_VERSION=${VERSION//\//-}
            BRANCH="chore/changelog-${SAFE_VERSION}"
            git checkout -b "$BRANCH"

            git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO}.git"
            git push --set-upstream origin "$BRANCH"

            echo "Pushed changelog to branch $BRANCH"
          else
            echo "No changes to CHANGELOG.md; nothing to commit."
          fi
  release:
    needs: [build, changelog]
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/**/*
          generate_release_notes: true
